import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";

const TAX_RATES = {
  AZ: 0.0062,
  CA: 0.0125,
  IN: 0.0137,
  NV: 0.0065,
  TX: 0.017,
  MI: 0.0321
};

const STATE_NAMES = {
  AZ: 'Arizona',
  CA: 'California',
  IN: 'Indiana',
  NV: 'Nevada',
  TX: 'Texas',
  MI: 'Michigan'
};

export default function PropertyCalculator() {
  const [inputs, setInputs] = useState({
    purchasePrice: 650000,
    downPaymentPercent: 0.2,
    loanAmount: 520000,
    interestRate: 0.02,
    loanYears: 15,
    state: 'TX',
    taxRate: TAX_RATES.TX,
    grossRent: 5000,
    maintenanceMonthly: 250
  });

  const calculateLoanAmount = () => {
    return inputs.purchasePrice * (1 - inputs.downPaymentPercent);
  };

  useEffect(() => {
    setInputs(prev => ({
      ...prev,
      loanAmount: calculateLoanAmount()
    }));
  }, [inputs.purchasePrice, inputs.downPaymentPercent]);

  const handleStateChange = (state) => {
    setInputs(prev => ({
      ...prev,
      state,
      taxRate: TAX_RATES[state]
    }));
  };

  const calculateMonthlyPayment = (principal, yearlyRate, years) => {
    const monthlyRate = yearlyRate / 12;
    const numberOfPayments = years * 12;
    return principal * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / 
           (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
  };

  const calculateOutputs = () => {
    const monthlyPI = calculateMonthlyPayment(
      inputs.loanAmount,
      inputs.interestRate,
      inputs.loanYears
    );
    
    const insurance = (inputs.purchasePrice * 0.01) / 12;
    const taxes = (inputs.purchasePrice * inputs.taxRate) / 12;
    const pmFee = inputs.grossRent * 0.10;
    const totalMonthly = monthlyPI + insurance + taxes + pmFee + inputs.maintenanceMonthly;
    
    const grossRents75 = inputs.grossRent * 0.75;
    const grossRents90 = inputs.grossRent * 0.9;
    const grossRents100 = inputs.grossRent;

    return {
      monthlyPI,
      insurance,
      taxes,
      pmFee,
      totalMonthly,
      cashFlow75: grossRents75 - totalMonthly,
      cashFlow90: grossRents90 - totalMonthly,
      cashFlow100: grossRents100 - totalMonthly
    };
  };

  const outputs = calculateOutputs();

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setInputs(prev => ({
      ...prev,
      [name]: parseFloat(value) || 0
    }));
  };

  return (
    <div className="p-6 max-w-6xl mx-auto">
      <h1 className="text-2xl font-bold mb-6">Property Investment Calculator</h1>
      
      {/* Main Input Section */}
      <Card className="mb-6">
        <CardContent className="pt-6">
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-6">
            <div className="col-span-2">
              <Label className="text-lg">Purchase Price ($)</Label>
              <Input 
                type="text" 
                name="purchasePrice"
                value={inputs.purchasePrice.toLocaleString()}
                onChange={(e) => {
                  const value = e.target.value.replace(/[^0-9]/g, '');
                  handleInputChange({
                    target: {
                      name: 'purchasePrice',
                      value: value
                    }
                  });
                }}
                className="bg-yellow-50 text-lg font-medium" 
              />
            </div>

            <div>
              <Label>Down Payment %</Label>
              <Input 
                type="number"
                name="downPaymentPercent"
                value={inputs.downPaymentPercent * 100}
                onChange={e => handleInputChange({
                  target: {
                    name: 'downPaymentPercent',
                    value: parseFloat(e.target.value) / 100
                  }
                })}
                className="bg-yellow-50"
                step="0.1"
              />
            </div>

            <div>
              <Label>Interest Rate %</Label>
              <Input 
                type="number"
                name="interestRate"
                value={inputs.interestRate * 100}
                onChange={e => handleInputChange({
                  target: {
                    name: 'interestRate',
                    value: parseFloat(e.target.value) / 100
                  }
                })}
                className="bg-yellow-50"
                step="0.1"
              />
            </div>

            <div>
              <Label>Loan Term</Label>
              <Select 
                value={inputs.loanYears.toString()} 
                onValueChange={(value) => handleInputChange({
                  target: {
                    name: 'loanYears',
                    value: parseInt(value)
                  }
                })}
              >
                <SelectTrigger className="bg-yellow-50">
                  <SelectValue placeholder="Select term" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="15">15 Years</SelectItem>
                  <SelectItem value="30">30 Years</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label>State</Label>
              <Select 
                value={inputs.state} 
                onValueChange={handleStateChange}
              >
                <SelectTrigger className="bg-yellow-50">
                  <SelectValue placeholder="Select state" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="AZ">{STATE_NAMES.AZ}</SelectItem>
                  <SelectItem value="CA">{STATE_NAMES.CA}</SelectItem>
                  <SelectItem value="IN">{STATE_NAMES.IN}</SelectItem>
                  <SelectItem value="NV">{STATE_NAMES.NV}</SelectItem>
                  <SelectItem value="TX">{STATE_NAMES.TX}</SelectItem>
                  <SelectItem value="MI">{STATE_NAMES.MI}</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="col-span-2">
              <Label>Tax Rate</Label>
              <Input 
                type="text"
                value={`${(inputs.taxRate * 100).toFixed(3)}%`}
                disabled
                className="bg-gray-100"
              />
            </div>

            <div className="col-span-2">
              <Label>Calculated Loan Amount</Label>
              <Input 
                type="text"
                value={`${inputs.loanAmount.toLocaleString()}`}
                disabled
                className="bg-gray-100"
              />
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Monthly Details Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        {/* Monthly Costs */}
        <Card>
          <CardHeader>
            <CardTitle>Monthly Expenses</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Principal & Interest</Label>
                <Input 
                  type="text" 
                  value={`$${outputs.monthlyPI.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`}
                  disabled 
                  className="bg-gray-100" 
                />
              </div>
              <div>
                <Label>Insurance</Label>
                <Input 
                  type="text"
                  value={`$${outputs.insurance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`}
                  disabled
                  className="bg-gray-100"
                />
              </div>
              <div>
                <Label>Property Taxes</Label>
                <Input 
                  type="text"
                  value={`$${outputs.taxes.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`}
                  disabled
                  className="bg-gray-100"
                />
              </div>
              <div>
                <Label>Property Management</Label>
                <Input 
                  type="text"
                  value={`$${outputs.pmFee.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`}
                  disabled
                  className="bg-gray-100"
                />
              </div>
            </div>
            <div>
              <Label>Monthly Maintenance</Label>
              <Input 
                type="number"
                name="maintenanceMonthly"
                value={inputs.maintenanceMonthly}
                onChange={handleInputChange}
                className="bg-yellow-50"
              />
            </div>
          </CardContent>
        </Card>

        {/* Income Analysis */}
        <Card>
          <CardHeader>
            <CardTitle>Cash Flow Analysis</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="mb-6">
              <Label>Expected Monthly Rent</Label>
              <Input 
                type="number"
                name="grossRent"
                value={inputs.grossRent}
                onChange={handleInputChange}
                className="bg-yellow-50"
              />
            </div>

            <div className="space-y-4">
              <div className="p-4 rounded-lg" style={{
                backgroundColor: outputs.cashFlow75 > 0 ? '#dcfce7' : '#fee2e2'
              }}>
                <Label>75% Occupancy Cash Flow</Label>
                <div className="text-2xl font-bold" style={{
                  color: outputs.cashFlow75 > 0 ? '#166534' : '#991b1b'
                }}>
                  ${outputs.cashFlow75.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </div>
              </div>

              <div className="p-4 rounded-lg" style={{
                backgroundColor: outputs.cashFlow90 > 0 ? '#dcfce7' : '#fee2e2'
              }}>
                <Label>90% Occupancy Cash Flow</Label>
                <div className="text-2xl font-bold" style={{
                  color: outputs.cashFlow90 > 0 ? '#166534' : '#991b1b'
                }}>
                  ${outputs.cashFlow90.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </div>
              </div>

              <div className="p-4 rounded-lg" style={{
                backgroundColor: outputs.cashFlow100 > 0 ? '#dcfce7' : '#fee2e2'
              }}>
                <Label>100% Occupancy Cash Flow</Label>
                <div className="text-2xl font-bold" style={{
                  color: outputs.cashFlow100 > 0 ? '#166534' : '#991b1b'
                }}>
                  ${outputs.cashFlow100.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </div>
              </div>
            </div>

            <div className="mt-4 p-4 bg-gray-100 rounded-lg">
              <h3 className="font-semibold mb-2">Investment Status</h3>
              <p className={`text-lg font-medium ${outputs.cashFlow75 <= 0 ? 'text-red-700' : 'text-green-700'}`}>
                {outputs.cashFlow75 <= 0 ? 'Not Recommended' : 'Good Investment'}
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
